<!DOCTYPE html>
<html lang="en">
<head>
    <script src="ChaosList.js" defer></script>
    <script src="enchantWorldLand.js" defer></script>
    <script src="personaLandList.js" defer></script>
    <script src="whackyLandList.js" defer></script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chaos Magic Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior-y: contain; 
        }
        .deck-button-wrapper { display: flex; flex-direction: column; align-items: stretch; }
        .deck-button { transition: all 0.2s ease-in-out; flex-grow: 1; position: relative; }
        .deck-button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .deck-draw-counter {
            position: absolute; top: 0.25rem; right: 0.25rem;
            background-color: rgba(0,0,0,0.7); color: white;
            font-size: 0.7rem; font-weight: bold;
            width: 1.25rem; height: 1.25rem; border-radius: 9999px;
            display: flex; align-items: center; justify-content: center;
            line-height: 1; box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        /* Unified style for secondary action buttons under deck buttons */
        .deck-action-button { 
            transition: all 0.2s ease-in-out; 
            font-size: 0.8rem; 
            padding-top: 0.4rem; 
            padding-bottom: 0.4rem; 
            font-medium;
            py-1 px-2 rounded-md shadow-sm mt-1 w-full;
        }
        .deck-action-button:hover { transform: translateY(-1px); }

        .card { transition: all 0.3s ease-in-out; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .effect-item { transition: background-color 0.2s ease; }
        .effect-item-icon { margin-right: 0.75rem; flex-shrink: 0; width: 1.25rem; height: 1.25rem; }
        .effect-item:hover { background-color: #4A5568; }
        .btn-action { transition: background-color 0.2s ease, transform 0.1s ease; }
        .btn-action:active { transform: scale(0.98); }
        .btn-modal-action {
            padding: 0.25rem 0.5rem; 
            font-size: 0.75rem; 
            border-radius: 0.375rem; 
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); 
            margin-left: 0.5rem; 
        }
        .btn-icon-modal {
            padding: 0.375rem;
            margin-left: 0.5rem;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #2D3748; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #718096; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #A0AEC0; }
        .modal {
            display: none; position: fixed; z-index: 1000;
            left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.75);
            align-items: center; justify-content: center;
        }
        .modal-content {
            background-color: #2D3748; color: #E2E8F0; margin: auto;
            padding: 20px; border-radius: 8px; width: 90%;
            max-width: 600px; /* Increased max-width for better readability of card lists */
            max-height: 80vh; display: flex;
            flex-direction: column; box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #4A5568; padding-bottom: 10px; margin-bottom: 15px;
        }
        .modal-title { font-size: 1.25rem; font-weight: 600; color: #9F7AEA; }
        .modal-close-button {
            color: #A0AEC0; font-size: 1.75rem; font-weight: bold;
            cursor: pointer; background: none; border: none; padding: 0 0.5rem;
        }
        .modal-close-button:hover, .modal-close-button:focus { color: #FFFFFF; text-decoration: none; }
        .modal-body { overflow-y: auto; flex-grow: 1; }
        
        /* Styles for items in both discard and all cards modals */
        .modal-card-item { 
            background-color: #4A5568; padding: 10px; border-radius: 6px; margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .modal-card-item-content {
            flex-grow: 1;
            margin-right: 0.5rem; /* Space between text and button (if any) */
        }
        .modal-card-item h4 { font-weight: 600; color: #B794F4; margin-bottom: 4px; }
        .modal-card-item p { font-size: 0.875rem; color: #CBD5E0; margin-bottom: 0.25rem; }

        .card-symbol-E, .card-symbol-P, .card-symbol-PW, .card-symbol-CHAOS, .card-symbol-TK, .card-symbol-H, .card-symbol-L, .card-symbol-D{
            background-color:#CAC5C0; /* Ensure this is visible or adjust as needed */
            /* Consider adding padding/margin if symbols.css doesn't handle it well */
        }
        .dice-button {
            background-color: #4A5568; 
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            margin: 0 0.25rem; 
        }
        .dice-button:hover {
            background-color: #2D3748;
        }
        .dice-button svg {
            width: 1.5rem; 
            height: 1.5rem;
            margin-right: 0.5rem;
        }
        #diceResult {
            margin-top: 0.75rem; 
            padding: 0.5rem; 
            background-color: #1A202C;
            border-radius: 0.375rem; 
            min-height: 2.5rem; 
            text-align: center;
            color: #A0AEC0; 
            font-weight: 500;
        }
    </style>
    <link href="./symbols.css" rel="stylesheet">
    </head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center p-4 selection:bg-purple-500 selection:text-white">

    <div class="w-full max-w-2xl mx-auto">
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-purple-400">Chaos</h1>
        </header>

        <section id="decksSection" class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-6">
            <div class="deck-button-wrapper">
                <button data-deck="chaos" class="deck-button bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md h-24 sm:h-32 flex items-center justify-center text-center">
                    Chaos Deck <span id="count-chaos" class="deck-draw-counter">0</span>
                </button>
                <button data-view-all="chaos" class="deck-action-button bg-red-700 hover:bg-red-800 text-white">View All Cards</button>
                <button data-view-discard="chaos" class="deck-action-button bg-red-800 hover:bg-red-900 text-white">View Discards</button>
            </div>
            <div class="deck-button-wrapper">
                <button data-deck="realm" class="deck-button bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md h-24 sm:h-32 flex items-center justify-center text-center">
                    Realm Enchantment <span id="count-realm" class="deck-draw-counter">0</span>
                </button>
                <button data-view-all="realm" class="deck-action-button bg-blue-700 hover:bg-blue-800 text-white">View All Cards</button>
                <button data-view-discard="realm" class="deck-action-button bg-blue-800 hover:bg-blue-900 text-white">View Discards</button>
            </div>
            <div class="deck-button-wrapper">
                <button data-deck="persona" class="deck-button bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md h-24 sm:h-32 flex items-center justify-center text-center">
                    Persona <span id="count-persona" class="deck-draw-counter">0</span>
                </button>
                <button data-view-all="persona" class="deck-action-button bg-green-700 hover:bg-green-800 text-white">View All Cards</button>
                <button data-view-discard="persona" class="deck-action-button bg-green-800 hover:bg-green-900 text-white">View Discards</button>
            </div>
            <div class="deck-button-wrapper">
                <button data-deck="whacky" class="deck-button bg-yellow-500 hover:bg-yellow-600 text-black font-semibold py-3 px-4 rounded-lg shadow-md h-24 sm:h-32 flex items-center justify-center text-center">
                    Whacky Rules <span id="count-whacky" class="deck-draw-counter text-white" >0</span>
                </button>
                <button data-view-all="whacky" class="deck-action-button bg-yellow-700 hover:bg-yellow-800 text-white">View All Cards</button>
                <button data-view-discard="whacky" class="deck-action-button bg-yellow-800 hover:bg-yellow-900 text-white">View Discards</button>
            </div>
        </section>

        <section id="drawnCardSection" class="mb-6 p-4 bg-gray-800 rounded-lg shadow-xl min-h-[350px] flex flex-col justify-center items-center text-center card" style="display: none;">
            <img id="drawnCardImage" src="" alt="Card Art" class="w-44 h-32 sm:w-56 sm:h-40 object-scale-down rounded-md mb-3">
            <h3 id="drawnCardName" class="text-xl font-semibold text-purple-300 mb-1"></h3>
            <p id="drawnCardEffect" class="text-gray-300 mb-4 text-sm sm:text-base px-2 text-left"></p> 
            <div class="flex space-x-3">
                <button id="moveToEffectButton" class="btn-action bg-indigo-500 hover:bg-indigo-600 text-white font-medium py-2 px-4 rounded-lg shadow">Move to In Effect</button>
                <button id="discardDrawnCardButton" class="btn-action bg-pink-500 hover:bg-pink-600 text-white font-medium py-2 px-4 rounded-lg shadow">Discard</button>
            </div>
        </section>

        <section id="inEffectSection" class="mb-6">
            <h2 class="text-2xl font-semibold mb-3 text-purple-400 border-b-2 border-gray-700 pb-2">Rules In Effect</h2>
            <div id="activeEffectsContainer" class="space-y-3 max-h-96 overflow-y-auto bg-gray-800 p-4 rounded-lg shadow-inner">
                <p id="noActiveEffects" class="text-gray-500 text-center">No rules currently in effect.</p>
            </div>
        </section>
        
        <div id="placeholderDrawnCard" class="mb-6 p-4 bg-gray-800 rounded-lg shadow-xl min-h-[350px] flex flex-col justify-center items-center text-center text-gray-500">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mb-4 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v11.494m0 0A8.966 8.966 0 013.75 15.75c-1.012 0-1.973-.292-2.782-.823M12 17.747c1.012 0 1.973.292 2.782.823M12 17.747A8.966 8.966 0 0020.25 15.75c1.012 0 1.973-.292 2.782-.823M12 17.747V6.253" />
                 <path stroke-linecap="round" stroke-linejoin="round" d="M9.75 8.25H14.25M9.75 10.75H14.25M9.75 13.25H14.25M5.25 8.25H7.75M5.25 10.75H7.75M5.25 13.25H7.75M16.25 8.25H18.75M16.25 10.75H18.75M16.25 13.25H18.75" />
            </svg>
            <p>Your drawn card will appear here.</p>
        </div>

        <footer class="text-center mt-8 mb-4">
            <section id="diceRollerSection" class="mb-6 bg-gray-800 p-4 rounded-lg">
                <h3 class="text-lg font-semibold text-purple-300 mb-3">Roll a Die</h3>
                <div class="flex justify-center space-x-2 sm:space-x-3">
                    <button id="rollD2" class="dice-button" title="Roll D2">
                        <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                            <title>D2</title>
                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" fill="none"/>
                            <text x="12" y="16" font-family="sans-serif" font-size="10" fill="currentColor" text-anchor="middle">2</text>
                          </svg> D2
                    </button>
                    <button id="rollD3" class="dice-button" title="Roll D3">
                        <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                            <title>D3</title>
                            <path d="M12 2 L22 20 L2 20 Z" stroke="currentColor" stroke-width="1.5" fill="none"/>
                            <text x="12" y="17" font-family="sans-serif" font-size="10" fill="currentColor" text-anchor="middle">3</text>
                          </svg> D3
                    </button>
                    <button id="rollD4" class="dice-button" title="Roll D4">
                        <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                            <title>D4</title>
                            <path d="M12 3 L21 19 H3 Z" stroke="currentColor" stroke-width="1.5" fill="none"/>
                            <text x="12" y="17" font-family="sans-serif" font-size="10" fill="currentColor" text-anchor="middle">4</text>
                          </svg> D4
                    </button>
                    <button id="rollD6" class="dice-button" title="Roll D6">
                        <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                            <title>D6</title>
                            <rect x="4" y="4" width="16" height="16" rx="2" stroke="currentColor" stroke-width="1.5" fill="none"/>
                            <circle cx="8" cy="8" r="1.5" fill="currentColor"/>
                            <circle cx="16" cy="8" r="1.5" fill="currentColor"/>
                            <circle cx="8" cy="16" r="1.5" fill="currentColor"/>
                            <circle cx="12" cy="12" r="1.5" fill="currentColor"/>
                            <circle cx="16" cy="16" r="1.5" fill="currentColor"/>
                          </svg> D6
                    </button>
                    <button id="rollD10" class="dice-button" title="Roll D10">
                        <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                            <title>D10</title>
                            <path d="M12 2 L18.18 5.31 L20.93 11.25 L17.07 17.69 L12 20 L6.93 17.69 L3.07 11.25 L5.82 5.31 Z" stroke="currentColor" stroke-width="1.5" fill="none"/>
                            <text x="11.5" y="13.5" font-family="sans-serif" font-size="7" fill="currentColor" text-anchor="middle">10</text>
                          </svg> D10
                    </button>
                </div>
                <div id="diceResult" class="mt-3 p-2 bg-gray-900 rounded-md min-h-[2.5rem] text-gray-400 font-medium text-center">
                    Roll result will appear here.
                </div>
            </section>

            <section class="mb-6">
                <button id="resetButton" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105">Reset Game</button>
            </section>

            <section class="mb-6 bg-gray-800 text-gray-600 p-4 rounded-lg">
                Thank you for playing Chaos. Complete rules are <a class="text-gray-400" href="https://i.4pcdn.org/tg/1447655855551.pdf">available</a>.<br/>
                <button id="basicRulesButton" class="text-gray-400 hover:underline cursor-pointer">Basic Rules</button>:
                <section class="text-left mt-2 overflow-hidden transition-all duration-300 max-h-0" id="basicRulesList">
                    <ol class="list-decimal list-inside pl-5">
                        <li>Chaos Phase is before untap.</li>
                        <li>You MUST roll, extra costs MUST be paid, no targets? the effect fizzles.</li>
                        <li>Roll EnchantWorld before game starts after muligans.</li>
                        <li>You get a "saving roll" when you die, heal to zero if the roll gives extra life congrats!</li>
                        <li>Chaos is colorless.</li>
                        <li>No spells or effects allowed during Chaos Phase.</li>
                        <li>Triggered Effects still trigger.</li>
                        <li>EnchantWorlds are enchantments.</li>
                        <li>Counter-rolls and Fork-rolls are rolls themselves when used.</li>
                        <li>Ignore rolls that give you extra rolls on extra rolls.</li>
                    </ol>
                </section>
                Â©2025 Marcus Wenzel 
            </section>
            
            <script>
              const basicRulesButton = document.getElementById('basicRulesButton');
              const basicRulesList = document.getElementById('basicRulesList');
              if (basicRulesButton && basicRulesList) { 
                basicRulesButton.addEventListener('click', () => {
                  basicRulesList.classList.toggle('max-h-0');
                  basicRulesList.classList.toggle('max-h-[500px]'); 
                });
              }
            </script>
        </footer>
    </div>

    <div id="discardModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="discardModalTitle" class="modal-title">Discard Pile</h3>
                <button id="closeDiscardModalButton" class="modal-close-button">&times;</button>
            </div>
            <div id="discardModalBody" class="modal-body">
                <p id="emptyDiscardMessage" class="text-gray-500 text-center">This discard pile is empty.</p>
                </div>
        </div>
    </div>

    <div id="allCardsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="allCardsModalTitle" class="modal-title">All Cards in Deck</h3>
                <button id="closeAllCardsModalButton" class="modal-close-button">&times;</button>
            </div>
            <div id="allCardsModalBody" class="modal-body">
                <p id="emptyAllCardsMessage" class="text-gray-500 text-center">This deck is currently empty or data is unavailable.</p>
                </div>
        </div>
    </div>
        
    <script>
        // Main Application Logic
        document.addEventListener('DOMContentLoaded', async () => { // Made DOMContentLoaded async
            // DOM Elements
            const decksSection = document.getElementById('decksSection');
            const drawnCardSection = document.getElementById('drawnCardSection');
            const placeholderDrawnCard = document.getElementById('placeholderDrawnCard');
            const drawnCardImage = document.getElementById('drawnCardImage');
            const drawnCardName = document.getElementById('drawnCardName');
            const drawnCardEffect = document.getElementById('drawnCardEffect'); 
            const moveToEffectButton = document.getElementById('moveToEffectButton');
            const discardDrawnCardButton = document.getElementById('discardDrawnCardButton');
            const activeEffectsContainer = document.getElementById('activeEffectsContainer');
            const noActiveEffectsMessage = document.getElementById('noActiveEffects');
            const resetButton = document.getElementById('resetButton');

            // Discard Modal DOM Elements
            const discardModal = document.getElementById('discardModal');
            const discardModalTitle = document.getElementById('discardModalTitle');
            const discardModalBody = document.getElementById('discardModalBody');
            const closeDiscardModalButton = document.getElementById('closeDiscardModalButton');
            const emptyDiscardMessage = document.getElementById('emptyDiscardMessage');

            // All Cards Modal DOM Elements
            const allCardsModal = document.getElementById('allCardsModal');
            const allCardsModalTitle = document.getElementById('allCardsModalTitle');
            const allCardsModalBody = document.getElementById('allCardsModalBody');
            const closeAllCardsModalButton = document.getElementById('closeAllCardsModalButton');
            const emptyAllCardsMessage = document.getElementById('emptyAllCardsMessage');


            // Dice Roller Elements
            const rollD2Button = document.getElementById('rollD2');
            const rollD3Button = document.getElementById('rollD3');
            const rollD4Button = document.getElementById('rollD4');
            const rollD6Button = document.getElementById('rollD6');
            const rollD10Button = document.getElementById('rollD10');
            const diceResultDisplay = document.getElementById('diceResult');

            // Game State
            let currentlyDrawnCard = null; 
            let activeEffects = []; 
            let discardPiles = { chaos: [], realm: [], persona: [], whacky: [] };
            let drawnCounts = { chaos: 0, realm: 0, persona: 0, whacky: 0 };

            const deckIcons = { 
                chaos: `<svg class="w-full h-full text-red-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm0-2a6 6 0 100-12 6 6 0 000 12zm0-4a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path><path d="M10 3.5A6.5 6.5 0 003.5 10H2a8 8 0 115.075-7.559L5.95 3.55A6.502 6.502 0 0010 3.5zM16.5 10A6.5 6.5 0 0010 3.5V2a8 8 0 11-7.559 5.075L3.55 5.95A6.502 6.502 0 0016.5 10z"></path></svg>`,
                realm: `<svg class="w-full h-full text-blue-400" fill="currentColor" viewBox="0 0 20 20"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg>`,
                persona: `<svg class="w-full h-full text-green-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg>`,
                whacky: `<svg class="w-full h-full text-yellow-400" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a6 6 0 00-6 6c0 1.282.406 2.47 1.076 3.451l-1.261 1.261a1 1 0 101.414 1.414l1.261-1.261A5.966 5.966 0 0010 14a6 6 0 006-6c0-1.282-.406-2.47-1.076-3.451l1.261-1.261a1 1 0 10-1.414-1.414l-1.261 1.261A5.966 5.966 0 0010 2zm0 10a4 4 0 110-8 4 4 0 010 8z"></path><path d="M6.228 7.205a.75.75 0 00-1.06 1.06l1.75 1.75a.75.75 0 001.06-1.06l-1.75-1.75zm8.602-1.06a.75.75 0 10-1.06 1.06l1.75 1.75a.75.75 0 101.06-1.06l-1.75-1.75z"></path></svg>`
            };
            
            let allDecks = {}; 

            const ManaSymbolService = (() => {
                let symbolMap = null; 
                let fetchPromise = null;

                async function fetchSymbolMap() {
                    if (symbolMap) return symbolMap;
                    if (!fetchPromise) {
                        fetchPromise = fetch('https://api.scryfall.com/symbology')
                            .then(res => res.json())
                            .then(data => {
                                if (!data || !data.data) throw new Error('Invalid symbol data');
                                const map = {};
                                data.data.forEach(symbol => {
                                    const match = symbol.symbol.match(/^\{([^{}\s]+)\}$/);
                                    if (match) map[match[1]] = symbol.english;
                                });
                                symbolMap = map;
                                return symbolMap;
                            })
                            .catch(err => {
                                console.error("Failed to fetch mana symbols:", err);
                                throw err; // Propagate error
                            });
                    }
                    return fetchPromise;
                }
                return { getSymbolMap: async () => await fetchSymbolMap() };
            })();
            
            async function replaceManaSymbols(effectText) {
                let symbolMap;
                try {
                    symbolMap = await ManaSymbolService.getSymbolMap();
                } catch (err) {
                    return effectText; // On error, return original text
                }

                const alreadyReplaced = new Set(); 
                const result = effectText.replace(/\{([^{}\s]+)\}/g, (match, symbolText, offset) => {
                    if (symbolMap[symbolText]) {
                        if (alreadyReplaced.has(offset)) return match;
                        for (let i = offset; i < offset + match.length; i++) {
                            alreadyReplaced.add(i);
                        }
                        return `<abbr class="card-symbol card-symbol-${symbolText}" title="${symbolMap[symbolText]}">{${symbolText}}</abbr>`;
                    }
                    return match; 
                });
                return result;
            }

            function insertDiceRollResults(input) {
                const dicePattern = /\b(\d+)d(\d+)([+-]\d+)?\b/g;
                return input.replace(dicePattern, (match, numDice, diceSides, modifier) => {
                    numDice = parseInt(numDice, 10);
                    diceSides = parseInt(diceSides, 10);
                    let modValue = modifier ? parseInt(modifier, 10) : 0;
                    let total = 0;
                    for (let i = 0; i < numDice; i++) {
                        total += Math.floor(Math.random() * diceSides) + 1;
                    }
                    total += modValue;
                    return `${match} <i>(Rolled: ${total})</i>`;
                });
            }

            // --- Pre-process Card Lists ---
            async function preprocessAllCardLists() {
                const listNames = ["chaosList", "realmEnchantmentList", "personaList", "whackyList"];
                const loadedLists = { chaosList, realmEnchantmentList, personaList, whackyList }; 

                for (const listName of listNames) {
                    const currentList = loadedLists[listName];
                    if (typeof currentList === 'undefined') {
                        console.error(`Critical Error: ${listName} is not defined. Make sure its .js file is loaded correctly.`);
                        return false; 
                    }
                    const processedCards = await Promise.all(currentList.map(async (card) => {
                        const processedEffect = await replaceManaSymbols(card.effect);
                        return { ...card, effect: processedEffect };
                    }));
                    
                    if (listName === "chaosList") globalThis.chaosList = processedCards;
                    else if (listName === "realmEnchantmentList") globalThis.realmEnchantmentList = processedCards;
                    else if (listName === "personaList") globalThis.personaList = processedCards;
                    else if (listName === "whackyList") globalThis.whackyList = processedCards;
                }
                return true; 
            }

            const processingSuccessful = await preprocessAllCardLists();

            if (processingSuccessful) {
                 allDecks = {
                    chaos: { list: globalThis.chaosList, name: "Chaos" },
                    realm: { list: globalThis.realmEnchantmentList, name: "Realm Enchantment" },
                    persona: { list: globalThis.personaList, name: "Persona" },
                    whacky: { list: globalThis.whackyList, name: "Whacky Rules" }
                };
            } else {
                console.error("Halting app initialization due to errors in pre-processing card lists.");
                const header = document.querySelector('header > h1');
                if (header && !document.getElementById('fatalErrorMsg')) {
                    const errorMsg = document.createElement('p');
                    errorMsg.id = 'fatalErrorMsg';
                    errorMsg.textContent = "Critical Error: Could not load or process card data. The application may not function correctly. Please check the console for details and try reloading.";
                    errorMsg.className = "text-red-500 text-xl font-bold my-4 text-center";
                    header.parentElement.insertBefore(errorMsg, header.nextSibling);
                }
                return; 
            }

            // --- Helper Functions ---
            const generateId = () => '_' + Math.random().toString(36).substr(2, 9);

            const updateDrawnCardDisplay = () => { 
                if (currentlyDrawnCard) {
                    drawnCardImage.src = currentlyDrawnCard.card.picture;
                    drawnCardImage.alt = currentlyDrawnCard.card.name;
                    drawnCardName.textContent = currentlyDrawnCard.card.name;
                    drawnCardEffect.innerHTML = insertDiceRollResults(currentlyDrawnCard.card.effect); 
                    
                    drawnCardEffect.classList.add('text-left'); 
                    const unorderedLists = drawnCardEffect.querySelectorAll('ul');
                    unorderedLists.forEach(ul => ul.classList.add('list-disc', 'list-inside', 'pl-5', 'mb-2'));
                    const orderedLists = drawnCardEffect.querySelectorAll('ol');
                    orderedLists.forEach(ol => ol.classList.add('list-decimal', 'list-inside', 'pl-5', 'mb-2'));
                    drawnCardSection.style.display = 'flex';
                    placeholderDrawnCard.style.display = 'none';
                } else {
                    drawnCardSection.style.display = 'none';
                    placeholderDrawnCard.style.display = 'flex';
                    drawnCardEffect.innerHTML = ''; 
                }
            };

            const updateActiveEffectsDisplay = () => { 
                activeEffectsContainer.innerHTML = ''; 
                if (activeEffects.length === 0) {
                    activeEffectsContainer.appendChild(noActiveEffectsMessage); 
                    noActiveEffectsMessage.style.display = 'block';
                } else {
                    noActiveEffectsMessage.style.display = 'none';
                    activeEffects.forEach(effect => {
                        const effectElement = document.createElement('div');
                        effectElement.className = 'effect-item bg-gray-700 hover:bg-gray-600 p-3 rounded-md shadow flex justify-between items-center';
                        
                        const iconSpan = document.createElement('span');
                        iconSpan.className = 'effect-item-icon'; 
                        iconSpan.innerHTML = deckIcons[effect.originalDeckKey] || deckIcons.whacky; 
                        effectElement.appendChild(iconSpan); 

                        const effectTextPara = document.createElement('p');
                        effectTextPara.className = 'text-sm text-gray-200 flex-grow mr-2';
                        effectTextPara.innerHTML = effect.effectText; 
                        
                        const unorderedLists = effectTextPara.querySelectorAll('ul');
                        unorderedLists.forEach(ul => ul.classList.add('list-disc', 'list-inside', 'pl-5', 'mb-2'));
                        const orderedLists = effectTextPara.querySelectorAll('ol');
                        orderedLists.forEach(ol => ol.classList.add('list-decimal', 'list-inside', 'pl-5', 'mb-2'));

                        effectElement.appendChild(effectTextPara);

                        const discardButton = document.createElement('button');
                        discardButton.className = 'btn-action bg-pink-600 hover:bg-pink-700 text-white text-xs font-medium py-1 px-2 rounded-md shadow-sm whitespace-nowrap';
                        discardButton.textContent = 'Discard Effect';
                        discardButton.onclick = () => discardEffect(effect.id);
                        effectElement.appendChild(discardButton);
                        
                        activeEffectsContainer.appendChild(effectElement);
                    });
                }
            };
            const updateDrawnCountsDisplay = () => { 
                for (const deckKey in drawnCounts) {
                    const counterElement = document.getElementById(`count-${deckKey}`);
                    if (counterElement) counterElement.textContent = drawnCounts[deckKey];
                }
            };
            
            //iterates over the decks sequentially for debugging
            const getNextCardNumber = (deckKey) =>{ 
                if (!getNextCardNumber.deckCounters) getNextCardNumber.deckCounters = {};
                if (getNextCardNumber.deckCounters[deckKey] === undefined) getNextCardNumber.deckCounters[deckKey] = 0;
                const currentCardNumber = getNextCardNumber.deckCounters[deckKey];
                if (allDecks && allDecks[deckKey] && allDecks[deckKey].list) {
                    getNextCardNumber.deckCounters[deckKey]++;
                    if (getNextCardNumber.deckCounters[deckKey] >= allDecks[deckKey].list.length) {
                        getNextCardNumber.deckCounters[deckKey] = 0;
                    }
                } else {
                    console.warn(`Deck with key '${deckKey}' not found or has no 'list' property.`);
                    return undefined; 
                }
                return currentCardNumber;
            };

            // --- Core Logic Functions ---
            const drawCard = (deckKey) => { 
                if (currentlyDrawnCard) discardCurrentDrawnCard();
                if (!allDecks[deckKey] || !allDecks[deckKey].list) { 
                    console.error(`Deck data for ${deckKey} is not available. External JS might not have loaded.`);
                    // Replaced alert with a less intrusive console log, as the app should still function.
                    console.warn(`Data for ${allDecks[deckKey] ? allDecks[deckKey].name : deckKey} deck is missing for drawing a card.`);
                    return;
                }
                const deckData = allDecks[deckKey];
                if (deckData.list.length > 0) {
                    //const randomIndex = getNextCardNumber(deckKey); //iterate over all cards sequentially
                    const randomIndex = Math.floor(Math.random() * deckData.list.length);
                    if (typeof randomIndex === 'undefined' || !deckData.list[randomIndex]) {
                         console.error(`Failed to get valid card index for deck ${deckKey}. Index: ${randomIndex}`);
                         // Replaced alert
                         console.warn(`Error drawing card from ${deckData.name}. Please try again.`);
                         return;
                    }
                    currentlyDrawnCard = { card: deckData.list[randomIndex], deckKey: deckKey };
                    drawnCounts[deckKey]++; 
                    updateDrawnCardDisplay();
                    updateDrawnCountsDisplay(); 
                } else {
                    console.warn(`Deck ${deckKey} is empty.`);
                    // Replaced alert
                    console.warn(`${deckData.name} deck is currently empty for drawing.`);
                }
            };
            const moveCurrentToEffect = () => {
                if (currentlyDrawnCard) {
                    const newEffect = {
                        id: generateId(),
                        effectText: currentlyDrawnCard.card.effect, 
                        originalDeckKey: currentlyDrawnCard.deckKey,
                        card: currentlyDrawnCard.card 
                    };
                    activeEffects.unshift(newEffect); 
                    currentlyDrawnCard = null; 
                    updateDrawnCardDisplay();
                    updateActiveEffectsDisplay();
                }
            };
            const discardCurrentDrawnCard = () => { 
                 if (currentlyDrawnCard) {
                    discardPiles[currentlyDrawnCard.deckKey].unshift(currentlyDrawnCard.card); 
                    currentlyDrawnCard = null;
                    updateDrawnCardDisplay();
                }
            };
            const discardEffect = (effectId) => { 
                const effectIndex = activeEffects.findIndex(effect => effect.id === effectId);
                if (effectIndex > -1) {
                    const effectToDiscard = activeEffects[effectIndex];
                    discardPiles[effectToDiscard.originalDeckKey].unshift(effectToDiscard.card); 
                    activeEffects.splice(effectIndex, 1);
                    updateActiveEffectsDisplay();
                }
            };

            const redrawCardFromDiscard = (cardToRedraw, deckKeyOfRedrawnCard) => {
                 if (currentlyDrawnCard) {
                    discardCurrentDrawnCard(); 
                }
                currentlyDrawnCard = { card: cardToRedraw, deckKey: deckKeyOfRedrawnCard };
                const pile = discardPiles[deckKeyOfRedrawnCard];
                const cardIndexInPile = pile.findIndex(discardedCard => 
                    discardedCard.name === cardToRedraw.name && discardedCard.effect === cardToRedraw.effect
                ); 
                
                if (cardIndexInPile > -1) { 
                    pile.splice(cardIndexInPile, 1);
                } else { 
                    console.warn("Could not find the exact re-drawn card in its discard pile. Removing first instance if names match.");
                    const fallbackIndex = pile.findIndex(discardedCard => discardedCard.name === cardToRedraw.name);
                    if (fallbackIndex > -1) {
                        pile.splice(fallbackIndex, 1);
                    } else {
                        console.error("Failed to remove re-drawn card from discard pile.");
                    }
                }
                updateDrawnCardDisplay();
                closeDiscardModal();   
            };

            // --- Modal Logic: Discard Pile ---
            const openDiscardModal = (deckKey) => { 
                const pile = discardPiles[deckKey];
                 if (!allDecks[deckKey]) {
                    console.error(`Deck data for ${deckKey} is not available for discard modal.`);
                    discardModalTitle.textContent = "Error";
                    discardModalBody.innerHTML = '<p class="text-red-500 text-center">Could not load discard pile: deck data missing.</p>';
                    discardModal.style.display = 'flex';
                    return;
                }
                discardModalTitle.textContent = `${allDecks[deckKey].name} Discard Pile`;
                discardModalBody.innerHTML = ''; 
                if (pile.length === 0) {
                    discardModalBody.appendChild(emptyDiscardMessage); 
                    emptyDiscardMessage.style.display = 'block';
                } else {
                    emptyDiscardMessage.style.display = 'none';
                    pile.forEach(card => { 
                        const cardElement = document.createElement('div');
                        cardElement.className = 'modal-card-item'; // Using generic class

                        const contentWrapper = document.createElement('div'); 
                        contentWrapper.className = 'modal-card-item-content';

                        const nameElement = document.createElement('h4');
                        nameElement.textContent = card.name;
                        contentWrapper.appendChild(nameElement);

                        const effectElement = document.createElement('p');
                        effectElement.innerHTML = card.effect;                         
                        const unorderedLists = effectElement.querySelectorAll('ul');
                        unorderedLists.forEach(ul => ul.classList.add('list-disc', 'list-inside', 'pl-5', 'mb-2'));
                        const orderedLists = effectElement.querySelectorAll('ol');
                        orderedLists.forEach(ol => ol.classList.add('list-decimal', 'list-inside', 'pl-5', 'mb-2'));
                        contentWrapper.appendChild(effectElement);

                        cardElement.appendChild(contentWrapper);

                        const redrawButton = document.createElement('button');
                        redrawButton.innerHTML = `<?xml version="1.0" encoding="utf-8"?><svg fill="#000000" class="w-5 h-5" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path fill="currentColor" class="cls-1" d="M6,3.6V0L0,6l6,6V8c6-.27,7.53,3.76,7.88,5.77a.27.27,0,0,0,.53,0C17.08,2.86,6,3.6,6,3.6Z"/></svg>`; 
                        redrawButton.className = 'rounded-lg btn-action btn-icon-modal bg-blue-500 hover:bg-blue-600 text-white align-sub';
                        redrawButton.title = 'Re-draw card';
                        redrawButton.onclick = () => redrawCardFromDiscard(card, deckKey);
                        cardElement.appendChild(redrawButton);

                        discardModalBody.appendChild(cardElement);
                    });
                }
                discardModal.style.display = 'flex';
            };
            const closeDiscardModal = () => { discardModal.style.display = 'none'; };

            // --- Modal Logic: View All Cards ---
            const openAllCardsModal = (deckKey) => {
                if (!allDecks[deckKey] || !allDecks[deckKey].list) {
                    console.error(`Deck data for ${deckKey} is not available for 'View All Cards' modal.`);
                    allCardsModalTitle.textContent = "Error";
                    allCardsModalBody.innerHTML = '<p class="text-red-500 text-center">Could not load card list: deck data missing.</p>';
                    allCardsModal.style.display = 'flex';
                    return;
                }

                const deckData = allDecks[deckKey];
                allCardsModalTitle.textContent = `All Cards in ${deckData.name}`;
                allCardsModalBody.innerHTML = ''; // Clear previous content

                if (deckData.list.length === 0) {
                    allCardsModalBody.appendChild(emptyAllCardsMessage);
                    emptyAllCardsMessage.style.display = 'block';
                } else {
                    emptyAllCardsMessage.style.display = 'none';
                    deckData.list.forEach(card => {
                        const cardElement = document.createElement('div');
                        cardElement.className = 'modal-card-item'; // Reusing the style

                        const contentWrapper = document.createElement('div');
                        contentWrapper.className = 'modal-card-item-content';

                        const nameElement = document.createElement('h4');
                        nameElement.textContent = card.name;
                        contentWrapper.appendChild(nameElement);

                        const effectElement = document.createElement('p');
                        effectElement.innerHTML = card.effect; // Effect text already processed with mana symbols
                        
                        // Apply list styling if any ul/ol are present in the effect
                        const unorderedLists = effectElement.querySelectorAll('ul');
                        unorderedLists.forEach(ul => ul.classList.add('list-disc', 'list-inside', 'pl-5', 'mb-2'));
                        const orderedLists = effectElement.querySelectorAll('ol');
                        orderedLists.forEach(ol => ol.classList.add('list-decimal', 'list-inside', 'pl-5', 'mb-2'));
                        
                        contentWrapper.appendChild(effectElement);
                        cardElement.appendChild(contentWrapper);
                        allCardsModalBody.appendChild(cardElement);
                    });
                }
                allCardsModal.style.display = 'flex';
            };
            const closeAllCardsModal = () => { allCardsModal.style.display = 'none'; };


            const resetGame = () => { 
                currentlyDrawnCard = null; activeEffects = [];
                discardPiles = { chaos: [], realm: [], persona: [], whacky: [] };
                drawnCounts = { chaos: 0, realm: 0, persona: 0, whacky: 0 }; 
                updateDrawnCardDisplay(); updateActiveEffectsDisplay(); updateDrawnCountsDisplay(); 
                closeDiscardModal(); 
                closeAllCardsModal(); // Also close the new modal on reset
                if (diceResultDisplay) diceResultDisplay.textContent = "Roll result will appear here."; 
            };

            // --- Dice Roller Logic ---
            const rollDie = (sides) => {
                let result = Math.floor(Math.random() * sides) + 1;
                if(sides === 2 ) result = result === 1 ? 'Heads' : 'Tails';
                diceResultDisplay.textContent = `D${sides} rolled: ${result}`;
                diceResultDisplay.classList.remove('text-gray-400'); 
                diceResultDisplay.classList.add('text-green-400'); 
            };

            if(rollD2Button) rollD2Button.addEventListener('click', () => rollDie(2));
            if(rollD3Button) rollD3Button.addEventListener('click', () => rollDie(3));
            if(rollD4Button) rollD4Button.addEventListener('click', () => rollDie(4));
            if(rollD6Button) rollD6Button.addEventListener('click', () => rollDie(6));
            if(rollD10Button) rollD10Button.addEventListener('click', () => rollDie(10));

            // --- Event Listeners (Main) ---
            decksSection.addEventListener('click', (event) => { 
                const target = event.target.closest('button[data-deck], button[data-view-discard], button[data-view-all]'); 
                if (!target) return;
                if (target.dataset.deck) drawCard(target.dataset.deck);
                else if (target.dataset.viewDiscard) openDiscardModal(target.dataset.viewDiscard);
                else if (target.dataset.viewAll) openAllCardsModal(target.dataset.viewAll); // Listener for new button
            });
            moveToEffectButton.addEventListener('click', moveCurrentToEffect);
            discardDrawnCardButton.addEventListener('click', discardCurrentDrawnCard);
            
            // Discard Modal Listeners
            closeDiscardModalButton.addEventListener('click', closeDiscardModal);
            discardModal.addEventListener('click', (event) => { if (event.target === discardModal) closeDiscardModal(); });
            
            // All Cards Modal Listeners
            closeAllCardsModalButton.addEventListener('click', closeAllCardsModal);
            allCardsModal.addEventListener('click', (event) => { if (event.target === allCardsModal) closeAllCardsModal(); });

            resetButton.addEventListener('click', resetGame);

            // Initial UI setup (only if processing was successful)
            if (processingSuccessful) {
                updateDrawnCardDisplay(); 
                updateActiveEffectsDisplay();
                updateDrawnCountsDisplay(); 
            }
        });
    </script>
</body>
</html>
